<h1 id="rls-supabase-biar-data-lo-gak-jadi-konsumsi-publik">RLS Supabase: Biar Data Lo Gak Jadi Konsumsi Publik<a aria-hidden="true" class="anchor-heading icon-link" href="#rls-supabase-biar-data-lo-gak-jadi-konsumsi-publik"></a></h1>
<p>Lo pasti pernah kepikiran: “Gimana caranya user cuma bisa ngakses data yang emang buat dia?” Nah, RLS atau Row-Level Security itu jawabannya. Di Supabase (dan di Postgres juga), RLS itu semacam <strong>penjaga pintu</strong>—dia bakal nentuin data mana yang boleh dan nggak boleh diakses sama user tertentu.</p>
<h2 id="apa-itu-rls"><strong>Apa Itu RLS?</strong><a aria-hidden="true" class="anchor-heading icon-link" href="#apa-itu-rls"></a></h2>
<p>Secara teknis, RLS itu fitur bawaan Postgres yang bikin lo bisa filter data langsung di level baris (row), bukan cuma kolom doang. Jadi, kalau lo punya tabel <strong>orders</strong> isinya 1 juta baris, user A cuma boleh liat order yang dia bikin doang—nggak bisa kepoin order orang lain. Semua logicnya ditulis di database, bukan di backend lo.</p>
<p>Gampangnya, <strong>RLS</strong> adalah fitur keren di Postgres yang bikin lo bisa atur siapa yang bisa lihat data di level baris (row). Jadi, bukan cuma tabel yang di-protect, tapi per <strong>baris</strong> data pun bisa lo atur aksesnya. RLS ini kayak satpam di pintu-pintu rumah lo – lo bisa atur siapa yang boleh lewat, siapa yang nggak.</p>
<h3 id="kenapa-penting"><strong>Kenapa Penting?</strong><a aria-hidden="true" class="anchor-heading icon-link" href="#kenapa-penting"></a></h3>
<p>Tanpa RLS, lo harus rely sama backend lo buat handle data filtering. Itu riskan banget. Misalnya, di backend lo lupa check <code>where user_id = session_user</code>, user bisa dapetin data orang lain—bahaya! Dengan RLS, lo <strong>mindahin logic proteksi</strong> langsung ke database. Hasilnya:</p>
<ul>
<li>Data lebih aman.</li>
<li>Backend lo lebih simpel (nggak perlu query filter yang ribet).</li>
<li>Semua permintaan ke database (termasuk API Supabase) udah auto-filtered.</li>
</ul>
<p>Lo bayangin kalo lo punya satu database tapi dipake rame-rame: ada admin, user biasa, dan customer premium. Tanpa RLS, kalo lo nggak hati-hati, siapa aja bisa lihat semua data. Bahaya, kan? Nah, RLS bikin lo bisa setel “aturan main” biar user A cuma liat data dia doang, admin bisa liat semua, dan lain-lain.</p>
<h2 id="cara-kerja-rls">Cara Kerja RLS<a aria-hidden="true" class="anchor-heading icon-link" href="#cara-kerja-rls"></a></h2>
<p>Secara default, Postgres <strong>nggak aktifin</strong> RLS. Lo harus nyalain dulu:</p>
<pre class="language-sql"><code class="language-sql"><span class="token keyword">alter</span> <span class="token keyword">table</span> profiles <span class="token keyword">enable</span> <span class="token keyword">row</span> <span class="token keyword">level</span> security<span class="token punctuation">;</span>
</code></pre>
<p>Abis itu, lo bikin policy. Misalnya, lo pengen user biasa cuma bisa liat datanya sendiri:</p>
<pre class="language-sql"><code class="language-sql"><span class="token keyword">create</span> policy <span class="token string">"user can view own profile"</span>
<span class="token keyword">on</span> profiles
<span class="token keyword">for</span> <span class="token keyword">select</span>
<span class="token keyword">using</span> <span class="token punctuation">(</span>auth<span class="token punctuation">.</span>uid<span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token operator">=</span> id<span class="token punctuation">)</span><span class="token punctuation">;</span>
</code></pre>
<p>Nah, <code>auth.uid()</code> ini di Supabase otomatis dapet dari JWT user yang login. Jadi lo nggak perlu nulis kode filter data di backend lo, semua udah dihandle sama database!</p>
<h2 id="contoh-use-case"><strong>Contoh Use Case</strong><a aria-hidden="true" class="anchor-heading icon-link" href="#contoh-use-case"></a></h2>
<p>Lo punya app SaaS buat beberapa tenant. Di sana ada admin yang harus bisa liat semua data, dan ada user biasa yang cuma boleh liat data organisasinya doang. Contohnya di tabel <code>profiles</code>:</p>
<ul>
<li>User Biasa: cuma boleh liat data user di tenant dia sendiri.</li>
<li>Admin: boleh liat data semua orang.</li>
<li>Guest / Anon: nggak boleh liat sama sekali.</li>
</ul>
<h3 id="simulasi-sederhana"><strong>Simulasi Sederhana</strong><a aria-hidden="true" class="anchor-heading icon-link" href="#simulasi-sederhana"></a></h3>
<p>Di Supabase, lo bisa bikin 2 policy di tabel <code>profiles</code> kayak gini:</p>
<pre class="language-sql"><code class="language-sql"><span class="token comment">-- Admin bisa akses semua</span>
<span class="token keyword">create</span> policy <span class="token string">"admin can access all profiles"</span>
<span class="token keyword">on</span> <span class="token keyword">public</span><span class="token punctuation">.</span>profiles
<span class="token keyword">as</span> permissive
<span class="token keyword">for</span> <span class="token keyword">all</span>
<span class="token keyword">to</span> authenticated
<span class="token keyword">using</span> <span class="token punctuation">(</span>
  auth<span class="token punctuation">.</span>jwt<span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token operator">-</span><span class="token operator">>></span> <span class="token string">'role'</span> <span class="token operator">=</span> <span class="token string">'admin'</span>
<span class="token punctuation">)</span><span class="token punctuation">;</span>

<span class="token comment">-- User biasa cuma bisa akses profil sendiri</span>
<span class="token keyword">create</span> policy <span class="token string">"user can access own profile"</span>
<span class="token keyword">on</span> <span class="token keyword">public</span><span class="token punctuation">.</span>profiles
<span class="token keyword">as</span> permissive
<span class="token keyword">for</span> <span class="token keyword">select</span>
<span class="token keyword">to</span> authenticated
<span class="token keyword">using</span> <span class="token punctuation">(</span>auth<span class="token punctuation">.</span>uid<span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token operator">=</span> id<span class="token punctuation">)</span><span class="token punctuation">;</span>
</code></pre>
<p>Jadi waktu ada request:</p>
<ul>
<li>Admin dapet full akses.</li>
<li>User biasa cuma liat data yang ID-nya sama dengan <code>auth.uid()</code>.</li>
<li>Kalau anon? Kena RLS—data nggak muncul sama sekali.</li>
</ul>
<h3 id="custom-claims-di-supabase"><strong>Custom Claims di Supabase</strong><a aria-hidden="true" class="anchor-heading icon-link" href="#custom-claims-di-supabase"></a></h3>
<p>Supabase support banget buat custom JWT claims—artinya lo bisa nyelipin info tambahan kayak <code>role</code>, <code>tenant_id</code>, atau apapun yang lo butuhin di JWT user. Nah, kenapa ini penting?</p>
<p>Biasanya, JWT default dari Supabase cuma punya info standar kayak <code>sub</code> (user id), <code>email</code>, sama <code>role</code> yang default (<code>authenticated</code> / <code>anon</code>). Tapi buat app multi-tenant, lo butuh role yang lebih spesifik—misalnya admin, sales, customer, dsb.</p>
<p>Di Supabase, caranya lewat <strong>Auth Hooks</strong>. Lo bisa bikin <strong>custom access token hook</strong> di PostgreSQL yang akan “selipin” field baru ke JWT sebelum dikasih ke user. Contoh:</p>
<pre class="language-sql"><code class="language-sql"><span class="token keyword">create</span> <span class="token operator">or</span> <span class="token keyword">replace</span> <span class="token keyword">function</span> <span class="token keyword">public</span><span class="token punctuation">.</span>custom_access_token_hook<span class="token punctuation">(</span>event jsonb<span class="token punctuation">)</span>
<span class="token keyword">returns</span> jsonb
<span class="token keyword">language</span> plpgsql
<span class="token keyword">as</span> $$
<span class="token keyword">declare</span>
  claims jsonb<span class="token punctuation">;</span>
  user_role <span class="token keyword">text</span><span class="token punctuation">;</span>
<span class="token keyword">begin</span>
  <span class="token comment">-- Ambil role dari tabel profiles</span>
  <span class="token keyword">select</span> role <span class="token keyword">into</span> user_role
  <span class="token keyword">from</span> <span class="token keyword">public</span><span class="token punctuation">.</span>profiles
  <span class="token keyword">where</span> id <span class="token operator">=</span> <span class="token punctuation">(</span>event<span class="token operator">-</span><span class="token operator">>></span><span class="token string">'sub'</span><span class="token punctuation">)</span>::uuid<span class="token punctuation">;</span>

  <span class="token comment">-- Kalo nggak ketemu, fallback ke 'user'</span>
  <span class="token keyword">if</span> user_role <span class="token operator">is</span> <span class="token boolean">null</span> <span class="token keyword">then</span>
    user_role :<span class="token operator">=</span> <span class="token string">'user'</span><span class="token punctuation">;</span>
  <span class="token keyword">end</span> <span class="token keyword">if</span><span class="token punctuation">;</span>

  <span class="token comment">-- Ambil claims dari event</span>
  claims :<span class="token operator">=</span> <span class="token keyword">coalesce</span><span class="token punctuation">(</span>event<span class="token operator">-</span><span class="token operator">></span><span class="token string">'claims'</span><span class="token punctuation">,</span> <span class="token string">'{}'</span><span class="token punctuation">)</span><span class="token punctuation">;</span>

  <span class="token comment">-- Tambahin custom claim 'role'</span>
  claims :<span class="token operator">=</span> jsonb_set<span class="token punctuation">(</span>claims<span class="token punctuation">,</span> <span class="token string">'{app_metadata, role}'</span><span class="token punctuation">,</span> to_jsonb<span class="token punctuation">(</span>user_role<span class="token punctuation">)</span>::jsonb<span class="token punctuation">)</span><span class="token punctuation">;</span>

  <span class="token comment">-- Update claims di event</span>
  event :<span class="token operator">=</span> jsonb_set<span class="token punctuation">(</span>event<span class="token punctuation">,</span> <span class="token string">'{claims}'</span><span class="token punctuation">,</span> claims<span class="token punctuation">)</span><span class="token punctuation">;</span>

  <span class="token keyword">return</span> event<span class="token punctuation">;</span>
<span class="token keyword">end</span><span class="token punctuation">;</span>
$$<span class="token punctuation">;</span>
</code></pre>
<p>Hasilnya? JWT user lo sekarang bakal punya <code>app_metadata.role</code> = “admin” atau “user”, sesuai yang lo simpen di tabel <code>profiles</code>. Ini yang nanti <strong>dipake di policy RLS</strong>!</p>
<p><strong>Tips</strong>
✅ <strong>Jangan asal nambahin claims</strong>—cuma yang emang dibutuhin buat RLS.
✅ <strong>Tes hook lo</strong>—biar JWT yang dihasilkan sesuai ekspektasi dan nggak ngerusak policy yang udah lo bikin.
✅ <strong>Hindari leak data sensitif</strong>—jangan selipin info yang nggak perlu di JWT.</p>
<hr>
<h2 id="best-practice"><strong>Best Practice</strong><a aria-hidden="true" class="anchor-heading icon-link" href="#best-practice"></a></h2>
<p>Jangan cuma bikin policy yang kelihatannya aman. Ada beberapa tips biar lo nggak keteteran:</p>
<ol>
<li><strong>Selalu tes policy lo</strong>—pakai akun dummy yang role-nya beda-beda.</li>
<li><strong>Pisahin policy buat read (select) sama write (insert/update/delete)</strong>—biar lo bisa detailin kontrolnya.</li>
<li><strong>Gunakan claim JWT</strong> kayak <code>role</code> atau <code>tenant_id</code> buat filter lebih spesifik—jadi bukan cuma ID user doang.</li>
<li><strong>Jangan kasih grant <code>select</code> atau <code>all</code> langsung ke <code>anon</code> / <code>authenticated</code></strong> tanpa policy. Tanpa policy, data lo kebuka semua.</li>
<li><strong>Kalau ada query yang harus admin-only, kasih policy spesifik</strong>—jangan sampe admin lo kena limit yang sama kayak user biasa.</li>
</ol>
<h2 id="reference">Reference<a aria-hidden="true" class="anchor-heading icon-link" href="#reference"></a></h2>
<ul>
<li><a href="https://supabase.com/docs/guides/database/postgres/row-level-security">Row Level Security di Supabase Docs</a></li>
<li><a href="https://www.postgresql.org/docs/current/ddl-rowsecurity.html">Postgres Official Docs</a>  </li>
<li><a href="https://supabase.com/docs/guides/auth/auth-hooks/custom-access-token-hook">Supabase Auth Hooks: Custom Access Token Hook</a></li>
</ul>